100 ; W-64.{POUND} FILE#3
110 ;
120 RENUM JSR CRUNCH:JSR CHRGET:LDA #10:STA RENINC
130 LDA #100:STA RENSTART
140 LDA #0:STA RENSTART+1
150 JSR CHRGOT
160 BEQ RENDEF
170 JSR GETFXD
180 STA RENSTART:STX RENSTART+1
190 ;
200 JSR COMMA
210 JSR GETFXD:BEQ OKINC
220 JMP ILLQTY
230 OKINC STA RENINC
240 ;
250 JSR CHRGOT:BEQ RENDEF
260 JSR COMMA
270 ;
280 RENDEF JSR LNRANGE
290 ;
300 LDA RENSTART:LDX RENSTART+1
310 STA INTVAL:STX INTVAL+1
320 JSR FINDLN
330 LDY #3:LDA (VARPTR),Y:CMP STRPTR+1:BCC RANGEBAD:BNE YOUBET:DEY
340 LDA (VARPTR),Y:CMP STRPTR:BCC RANGEBAD
350 YOUBET LDA STRPTR:LDX STRPTR+1
360 STA INTVAL:STX INTVAL+1
370 JSR FINDLN
380 LDA VARPTR:LDX VARPTR+1
390 STA RENGET:STX RENGET+1
400 ;
410 LDA ENDPTR:LDX ENDPTR+1
420 STA RENENDLN:STX RENENDLN+1
430 STA INTVAL:STX INTVAL+1
440 INC INTVAL:BNE STCOUNT
450 INC INTVAL+1
460 STCOUNT JSR COUNTEM
470 ;
480 JSR MULT
490 LDA RENTEMP+1:CMP #$FA:BCC RANGEOK
500 RANGEBAD LDA #<RENMSGE1:LDY #>RENMSGE1:JSR STROUT:JMP READY
510 ;
520 RANGEOK JSR FINDLN:JSR RGETPTR
530 LDY #1:LDA (GETPTR),Y:BEQ THEMEAT
540 LDY #3:LDA RENTEMP+1:CMP (GETPTR),Y:BCC THEMEAT
550 BNE RANGEBAD
560 LDA RENTEMP:DEY:CMP (GETPTR),Y:BCS RANGEBAD
570 THEMEAT LDA STARTB:LDX STARTB+1
580 STA GETPTR:STX GETPTR+1
590 ;
600 ; PASS1
610 ;
620 RESETQU LDY #0:STY QUMODE
630 LINKLOPP LDY #1:LDA (GETPTR),Y:BNE LINKOK
640 RENDONE1 JMP PASS2
650 ;
660 LINKOK INY:LDA (GETPTR),Y:STA INTVAL:INY:LDA (GETPTR),Y:STA INTVAL+1
670 LDY #4:JSR UPDATE:JSR SGETPTR3:LDY #$FF
680 ALOOP INY:ALOOP2 LDA (GETPTR),Y:BEQ RLNDONE
690 CMP #34:BEQ QUFOUND
700 LDX QUMODE:BNE ALOOP
710 LDX #6:TABLELOP CMP RENTBLE-1,X:BEQ RENBINGO
720 DEX:BNE TABLELOP
730 BEQ ALOOP
740 ;
750 QUFOUND LDA QUMODE:EOR #$FF:STA QUMODE
760 JMP ALOOP
770 ;
780 RLNDONE INY:JSR UPDATE:JMP RESETQU
790 ;
800 RENBINGO PHA:JSR UPDATE:LDY #0:PLA
810 CMP #$CB:BNE RENBING2:JSR CHRGET
820 CMP #$A4:BNE ALOOP2
830 RENBING2 JSR CHRGET:BCS ALOOP2
840 ;
850 JSR SINTVAL:JSR SGETPTR2:JSR CHRGOT:JSR STRFAC:JSR FLFXD
860 ;
870 JSR CKRANGE:BEQ NEEDCHNG
880 JMP AFTERNUM
890 ;
900 ;
910 NEEDCHNG LDA INTVAL:LDX INTVAL+1
920 STA RENENDLN:STX RENENDLN+1
930 JSR COUNTEM:BEQ SOMELAB:LDA #$FF:STA RENCOUNT:STA RENCOUNT+1
940 SOMELAB JSR SPACE
950 ;
960 JSR MULT
970 LDX RENTEMP:LDA RENTEMP+1
980 STX INTVAL:STA INTVAL+1
990 JSR PRINTLN
1000 LDY RENTEMP:LDA RENTEMP+1:JSR FXDFL
1010 ;
1020 JSR RGETPTR3:LDX #$FF
1030 ;
1040 DOITLOOP LDY #0:INX
1050 LDA GETPTR+1:CMP TEMPC+1
1060 BCC NOPROB2:BNE DONETHIS
1070 LDA GETPTR:CMP TEMPC
1080 BCS DONETHIS
1090 NOPROB2 LDA (GETPTR),Y:STA BUFF,X:INY
1100 JSR UPDATE:JMP DOITLOOP
1110 DONETHIS LDY #0:LDA $0100:CMP #"-":BNE BIGLOOP:STA BUFF,X:INX
1120 BIGLOOP LDA $0101,Y:BEQ DONEPT2:STA BUFF,X:INY:INX:BNE BIGLOOP
1130 DONEPT2 STX TEMPH:JSR RGETPTR2:JSR CHRGOT:JSR STRFAC:JSR CHRGOT
1140 LDX TEMPH:LDY #0:BIG2LOOP CMP #0:STA BUFF,X:BEQ DONEPT3
1150 INX:INY:LDA (GETPTR),Y:JMP BIG2LOOP
1160 ;
1170 DONEPT3 INX:INX:STA BUFF,X:INX:INX:INX:STX $0B
1180 JSR RINTVAL:JSR PUTIN
1190 JSR RGETPTR2:JSR STRFAC
1200 LDA STRPTR:LDX STRPTR+1
1210 STA INTVAL:STX INTVAL+1
1220 JSR FINDLN:LDA VARPTR:LDX VARPTR+1
1230 STA RENGET:STX RENGET+1
1240 ;
1250 AFTERNUM JSR RINTVAL
1260 ;
1270 JSR CHRGOT:CMP #",":BEQ GETNEXT1
1280 CMP #$AB:BEQ GETNEXT1
1290 LDY #0:STY QUMODE:JMP ALOOP2
1300 ;
1310 GETNEXT1 JMP RENBING2
1320 ;
1330 ;
1340 ;
1350 GETFXD JSR INPFXD:GETINT LDA INTVAL
1360 LDX INTVAL+1:RTS
1370 ;
1380 ;
1390 MULT LDA RENINC:STA TEMPG:LDA RENSTART:LDX RENSTART+1
1400 STA RENTEMP:STX RENTEMP+1
1410 LDA #0:STA MULTFLAG
1420 ;
1430 LDX #8
1440 MULTLOOP LSR RENINC
1450 BCC DONTADD
1460 LDA MULTFLAG:BNE MULTERR
1470 LDA RENCOUNT
1480 CLC:ADC RENTEMP
1490 STA RENTEMP
1500 LDA RENCOUNT+1
1510 ADC RENTEMP+1
1520 STA RENTEMP+1
1530 ;
1540 DONTADD ASL RENCOUNT
1550 ROL RENCOUNT+1
1560 ROL MULTFLAG
1570 DEX
1580 BNE MULTLOOP
1590 ;
1600 LDA TEMPG:STA RENINC
1610 RTS
1620 MULTERR LDA #$FF
1630 STA RENTEMP:STA RENTEMP+1:LDA TEMPG:STA RENINC
1640 RTS
1650 ;
1660 PASS2 LDA RENGET:LDX RENGET+1
1670 ;
1680 STA GETPTR:STX GETPTR+1
1690 PASS2LP LDY #1:LDA (GETPTR),Y:BEQ PASS2DN
1700 LDY #3:LDA (GETPTR),Y
1710 CMP ENDPTR+1:BCC NOPROB:BNE PASS2DN
1720 DEY:LDA (GETPTR),Y
1730 CMP ENDPTR:BCC NOPROB:BNE PASS2DN
1740 ;
1750 NOPROB LDY #2:LDA RENSTART
1760 STA (GETPTR),Y
1770 INY:LDA RENSTART+1
1780 STA (GETPTR),Y
1790 ;
1800 LDY #0:LDA (GETPTR),Y:TAX
1810 INY:LDA (GETPTR),Y
1820 STA GETPTR+1:STX GETPTR
1830 LDA RENINC
1840 CLC:ADC RENSTART:STA RENSTART
1850 BCC PASS2LP
1860 LDA RENSTART+1:ADC #0:STA RENSTART+1
1870 JMP PASS2LP
1880 ;
1890 PASS2DN JMP READY
1900 ;
1910 ;
1920 SERROR9 JMP SERROR
1930 ;
1940 MEMORY LDA $$FF:STA ENDPTR:STA ENDPTR+1
1950 DEC GETPTR:LDA GETPTR:CMP #$FF:BNE NOSUBT
1960 DEC GETPTR+1
1970 NOSUBT JSR INPADD
1980 STA STRPTR:STX STRPTR+1
1990 JSR UPDATE:JSR CHRGET:BEQ GETGOING:CMP #",":BNE SERROR9
2000 JSR INPADD
2010 STA ENDPTR:STX ENDPTR+1
2020 ;
2030 GETGOING JSR CGRET

2040 LLOOPP JSR STOPSHFT:BEQ PASS2DN
2050 LDA STRPTR+1:CMP #>BLOCK:BCC LETEM1
2060 LDA #>BLOCK:CLC:ADC #$10:STA TEMPH:LDY STRPTR+1:CPY TEMPH:BCS LETEM1
2070 ;
2080 JMP READY
2090 ;
2100 LETEM1 LDA #".":JSR PRINT
2110 LDA STRPTR+1:LDX STRPTR
2120 JSR PRINTADD
2130 LDY #0
2140 PRINTMOR JSR SPACE
2150 LDA (STRPTR),Y
2160 STY TEMPH:JSR PRINTBYT:LDY TEMPH
2170 INY:CPY #8:BNE PRINTMOR
2180 JSR SPACE
2190 LDA #"{REVERSE ON}":JSR PRINT
2200 LDY #0
2210 BYTLOOP LDA (STRPTR),Y
2220 LDX #0:STX QUMODE
2230 CMP #161:BCS OOKK
2240 CMP #32:BCC NOTOOKK
2250 CMP #128:BCC OOKK
2260 NOTOOKK LDA #$2E
2270 OOKK JSR PRINT
2280 INY:CPY #8:BNE BYTLOOP
2290 ;
2300 TYA:CLC:ADC STRPTR:STA STRPTR
2310 LDA STRPTR+1:ADC #0:STA STRPTR+1
2320 JSR CGRET
2330 ;
2340 ;
2350 LDA STRPTR+1:CMP ENDPTR+1:BCC GOLLOOPP
2360 BNE NOLLOOPP
2370 ;
2380 LDA STRPTR:CMP ENDPTR:BCC GOLLOOPP
2390 BNE NOLLOOPP
2400 ;
2410 GOLLOOPP JMP LLOOPP
2420 NOLLOOPP JMP READY
2430 ;
2440 ;PUT THE LINE IN
2450 PUTIN JSR $A613    ; FIND BASIC LINE
2460 BCC L1
2470 LDY #1:LDA ($5F),Y
2480 STA $23:LDA $2D:STA $22
2490 LDA $60:STA $25:LDA $5F
2500 DEY:SBC ($5F),Y
2510 CLC:ADC $2D
2520 STA $2D:STA $24
2530 LDA $2E:ADC #$FF
2540 STA $2E:SBC $60
2550 TAX
2560 SEC:LDA $5F
2570 SBC $2D:TAY
2580 BCS L2
2590 INX:DEC $25
2600 L2 CLC:ADC $22
2610 BCC L3
2620 DEC $23:CLC
2630 L3 LDA ($22),Y
2640 STA ($24),Y
2650 INY:BNE L3
2660 INC $23:INC $25
2670 DEX:BNE L3
2680 L1 JSR BACKTEXT:JSR NEW ; UNDER [ NEW ]
2690 JSR RECHAIN
2700 LDA BUFF
2710 BEQ RETRN
2720 CLC:LDA $2D
2730 STA $5A:ADC $0B
2740 STA $58:LDY $2E
2750 STY $5B
2760 BCC L4
2770 INY
2780 L4 STY $59
2790 JSR MOVEMEM ; MOVE MEMORY
2800 LDA INTVAL:LDY INTVAL+1
2810 STA $01FE:STY $01FF
2820 LDA $31:LDY $32  ;END BASIC
2830 STA $2D:STY $2E  ;START BASIC VARS
2840 LDY $0B
2850 DEY
2860 L5 LDA $01FC,Y:STA ($5F),Y
2870 DEY:BPL L5
2880 JSR BACKTEXT:JSR NEW ; UNDER [ NEW ]
2890 JSR RECHAIN
2900 ;
2910 RETRN RTS
2920 ;
2930 NEW LDA $37:LDY $38
2940 STA $33:STY $34
2950 LDA $2D:LDY $2E
2960 STA $2F:STY $30
2970 STA $31:STY $32
2980 JSR $A81D
2990 LDX #$19:STX $16
3000 LDA #0:STA $3E:STA $10
3010 RTS
3020 ;
3030 COUNTEM LDA RENGET:LDX RENGET+1
3040 STA CNTPTR:STX CNTPTR+1
3050 LDY #0:STY RENCOUNT:STY RENCOUNT+1
3060 ;
3070 COUNTLP LDY #1:LDA (CNTPTR),Y
3080 BNE CNTNOVER:LDA #1:RTS
3090 ;
3100 CNTNOVER LDY #3:LDA (CNTPTR),Y
3110 CMP RENENDLN+1
3120 BCC CNTON
3130 BNE CNTDONE
3140 DEY:LDA (CNTPTR),Y
3150 CMP RENENDLN
3160 BCC CNTON
3170 ;
3180 CNTDONE RTS
3190 ;
3200 CNTON LDY #0
3210 LDA (CNTPTR),Y:TAX
3220 INY:LDA (CNTPTR),Y:STA CNTPTR+1:STX CNTPTR
3230 INC RENCOUNT:BNE COUNTLP
3240 INC RENCOUNT+1:BNE COUNTLP
3250 ;
3260 SINTVAL LDA INTVAL:LDX INTVAL+1
3270 STA TEMPA:STX TEMPB
3280 RTS
3290 ;
3300 RINTVAL LDA TEMPA:LDX TEMPB
3310 STA INTVAL:STX INTVAL+1
3320 RTS
3330 ;
3340 SGETPTR2 LDA GETPTR:LDX GETPTR+1
3350 STA TEMPC:STX TEMPC+1
3360 RTS
3370 ;
3380 RGETPTR2 LDA TEMPC:LDX TEMPC+1
3390 STA GETPTR:STX GETPTR+1
3400 RTS
3410 ;
3420 CKRANGE LDA INTVAL+1:CMP STRPTR+1
3430 BEQ ISEQU
3440 BCS CKENDPTR
3450 NOTRNGE LDA #1:RTS
3460 INRANGE LDA #0:RTS
3470 ;
3480 ISEQU LDA INTVAL:CMP STRPTR
3490 BCC NOTRNGE
3500 ;
3510 CKENDPTR LDA INTVAL+1:CMP ENDPTR+1
3520 BCC INRANGE
3530 BNE NOTRNGE
3540 LDA INTVAL:CMP ENDPTR
3550 BCC INRANGE
3560 BEQ INRANGE
3570 BCS NOTRNGE
3580 ;
3590 FXDFL CMP #$80:BCC SKP32768
3600 AND #$7F
3610 JSR SFXDFL:LDA #<CONSTANT:LDY #>CONSTANT
3620 JSR ADDEM
3630 JMP STRIT
3640 ;
3650 SKP32768 JSR SFXDFL
3660 STRIT JSR CONVFAC1
3670 RTS
3680 ;
3690 SGETPTR3 LDA GETPTR:LDX GETPTR+1
3700 STA TEMPI:STX TEMPI+1
3710 RTS
3720 ;
3730 RGETPTR3 LDA TEMPI:LDX TEMPI+1
3740 STA GETPTR:STX GETPTR+1
3750 RTS
3760 ;
3770 BONJOUR LDA #"?":STA DELIM:LDX #17:STX FILELEN
3780 JSR CHRGOT:JSR INPFILE
3790 LDA #<BONJOURM:LDY #>BONJOURM:JSR STROUT
3800 BONGET JSR GET:CMP #"{F8}":BEQ LESAVE
3810 CMP #"N":BNE BONGET:JMP READY
3820 ;
3830 LESAVE LDY #0:LDA SAVETBLE+1:STA TEMPJ:STY SAVETBLE+1
3840 LDA SAVETBLE+2:STA TEMPJ+1:STY SAVETBLE+2
3850 JSR SAVEEE2
3860 LDA TEMPJ:STA SAVETBLE+1
3870 LDA TEMPJ+1:STA SAVETBLE+2
3880 JMP DS
3890 ;
3900 ;
3910 ;
3920 RENTBLE .BYTE $8A,$9B,$CB,$A7,$8D,$89
3930 ;RUN,LIST,GO,THEN,GOSUB,GOTO
3940 RENMSGE1 .ASC " ** ILLEGAL LINE RANGE ** ":.BYTE 13,0
3950 BONJOURM .BYTE 13:.ASC " ? ".BYTE 13,O
3960 CONSTANT .BYTE $90,0,0,0,0
3970 .END 8,"W-64.E5"
3980 TOK64
3990 1.0)